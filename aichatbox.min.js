document.addEventListener("DOMContentLoaded", function () {
    const chatWidgetContainer = document.getElementById("chat-widget-container");
    if (!chatWidgetContainer) {
        console.error("Chat widget container with ID 'chat-widget-container' not found.");
        return;
    }

    const dentistryCd = chatWidgetContainer.dataset.dentistryCd || null;

    chatWidgetContainer.innerHTML = `
            <div id="chat-widget" class="chat-widget">
                <div class="chat-header">
                    <span id="chat-header-title">BOPO Assistant</span>
                    <button id="chat-close-btn" class="chat-close-btn">&times;</button>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <div id="history-loader"><div class="spinner"></div></div>
                    <div class="chat-loader hidden" id="chat-loader"></div>
                </div>
                <form class="chat-input" id="chat-form">
                    <input type="text" id="message-input" placeholder="Nháº­p tin nháº¯n..." autocomplete="off">
                    <button type="submit" disabled>Gá»­i</button>
                </form>
            </div>
            <button id="chat-toggle">ðŸ’¬</button>
             `;

    const chatWidget = document.getElementById("chat-widget");
    const chatToggle = document.getElementById("chat-toggle");
    const chatMessages = chatWidget.querySelector("#chat-messages");
    const chatForm = chatWidget.querySelector("#chat-form");
    const messageInput = chatWidget.querySelector("#message-input");
    const chatLoader = chatWidget.querySelector("#chat-loader");
    const chatCloseBtn = chatWidget.querySelector("#chat-close-btn");
    const sendButton = chatForm.querySelector("button");
    const historyLoader = chatWidget.querySelector("#history-loader");
    const headerTitle = chatWidget.querySelector("#chat-header-title");
    var messageHello = '';

    const CHAT_API_URL = "http://192.168.2.175:5000/api";
    const DENTISTRY_API_URL = "http://192.168.2.175:8600/api/dentistries";

    let sessionId = localStorage.getItem(`chatSessionId-${dentistryCd || 'general'}`) || crypto.randomUUID();
    localStorage.setItem(`chatSessionId-${dentistryCd || 'general'}`, sessionId);

    let currentPage = 1;
    let isLoadingMore = false;
    let hasMoreMessages = true;
    let hasInitiallyLoaded = false;

    async function initializeWidget() {
        if (!dentistryCd) {
            messageHello = 'ChÃ o báº¡n, mÃ¬nh lÃ  trá»£ lÃ½ áº£o BOPO! MÃ¬nh cÃ³ thá»ƒ giÃºp gÃ¬ cho báº¡n?';
            return; // KhÃ´ng lÃ m gÃ¬ náº¿u lÃ  chat chung
        }

        const url = `${DENTISTRY_API_URL}?dentistryCd=${dentistryCd}`;
        try {
            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();
                // API tráº£ vá» má»™t Ä‘á»‘i tÆ°á»£ng khi tÃ¬m theo mÃ£
                if (data && data.name) {
                    headerTitle.textContent = data.name;
                    messageHello = 'ChÃ o báº¡n, mÃ¬nh lÃ  trá»£ lÃ½ áº£o cá»§a ' + data.name + '! MÃ¬nh cÃ³ thá»ƒ giÃºp gÃ¬ cho báº¡n?';
                }
            }
        } catch (error) {
            console.error("Failed to fetch dentistry name for header:", error);
            // Giá»¯ láº¡i tÃªn máº·c Ä‘á»‹nh náº¿u cÃ³ lá»—i
        }
    }

    async function loadChatHistory(isInitialLoad) {
        if (isLoadingMore) return;
        if (isInitialLoad) chatLoader.classList.remove("hidden");
        else historyLoader.style.display = "block";
        isLoadingMore = true;

        const historyUrl = `${CHAT_API_URL}/webchat/history/${sessionId}?page=${currentPage}&pageSize=10`;

        try {
            const response = await fetch(historyUrl);
            if (!response.ok) {
                if (isInitialLoad) addWelcomeMessage();
                hasMoreMessages = false; return;
            }
            const data = await response.json();
            const history = data.messages;
            hasMoreMessages = data.hasMoreMessages;

            if (isInitialLoad && (!history || history.length === 0)) {
                addWelcomeMessage(); return;
            }

            const oldScrollHeight = chatMessages.scrollHeight;

            const reversedHistory = history.reverse();
            for (const msg of reversedHistory) {
                if (msg.sender.toLowerCase() === 'bot') {
                    // Thá»­ xá»­ lÃ½ tin nháº¯n cá»§a bot nhÆ° má»™t cÃ¢u lá»‡nh
                    const handledAsCommand = await handleBotReply(msg.content, true, msg.timestamp);
                    // Náº¿u khÃ´ng pháº£i lÃ  lá»‡nh, hiá»ƒn thá»‹ nhÆ° bÃ¬nh thÆ°á»ng
                    if (!handledAsCommand) {
                        addMessage('bot', msg.content, true, msg.timestamp);
                    }
                } else {
                    // Tin nháº¯n cá»§a ngÆ°á»i dÃ¹ng luÃ´n Ä‘Æ°á»£c hiá»ƒn thá»‹
                    addMessage('user', msg.content, true, msg.timestamp);
                }
            }

            updateAllDateSeparators();

            if (isInitialLoad) chatMessages.scrollTop = chatMessages.scrollHeight;
            else chatMessages.scrollTop = chatMessages.scrollHeight - oldScrollHeight;

            currentPage++;
        } catch (error) {
            console.error("Failed to load chat history:", error);
            if (isInitialLoad) addWelcomeMessage();
        } finally {
            isLoadingMore = false;
            chatLoader.classList.add("hidden");
            historyLoader.style.display = "none";
            if (isInitialLoad) hasInitiallyLoaded = true;
        }
    }

    function updateAllDateSeparators() {
        chatMessages.querySelectorAll(".date-separator").forEach(el => el.remove());
        const allMessageWrappers = chatMessages.querySelectorAll(".message-wrapper");
        let lastDate = null;
        allMessageWrappers.forEach(wrapper => {
            const timestamp = wrapper.dataset.timestamp;
            if (!timestamp) return;
            const messageDate = new Date(timestamp);
            const messageDateString = messageDate.toDateString();
            if (lastDate !== messageDateString) {
                addDateSeparator(messageDate, wrapper);
                lastDate = messageDateString;
            }
        });
    }

    function addDateSeparator(date, beforeElement) {
        const separatorElement = document.createElement("div");
        separatorElement.classList.add("date-separator");
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        if (date.toDateString() === today.toDateString()) separatorElement.textContent = "HÃ´m nay";
        else if (date.toDateString() === yesterday.toDateString()) separatorElement.textContent = "HÃ´m qua";
        else separatorElement.textContent = date.toLocaleDateString("vi-VN", { weekday: "long", year: "numeric", month: "numeric", day: "numeric" });
        chatMessages.insertBefore(separatorElement, beforeElement);
    }

    function addMessage(sender, text, prepend = false, timestamp = null) {
        const wrapper = document.createElement("div");
        wrapper.classList.add("message-wrapper", sender);
        const messageElement = document.createElement("div");
        messageElement.classList.add("message");
        const isoTimestamp = timestamp || new Date().toISOString();
        wrapper.dataset.timestamp = isoTimestamp;
        const textElement = document.createElement("div");
        textElement.classList.add("text");
        if (sender === "bot" && text === "...") {
            textElement.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
        } else {
            textElement.innerHTML = text.replace(/\n/g, '<br>');
        }
        const timestampElement = document.createElement("div");
        timestampElement.classList.add("message-timestamp");
        const date = new Date(isoTimestamp);
        timestampElement.textContent = date.toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit" });
        messageElement.appendChild(textElement);
        wrapper.appendChild(messageElement);
        wrapper.appendChild(timestampElement);
        if (prepend) chatMessages.insertBefore(wrapper, historyLoader.nextSibling);
        else {
            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    async function sendMessage(text) {
        addMessage("user", text);
        updateAllDateSeparators();
        messageInput.value = "";
        sendButton.disabled = true;
        addMessage("bot", "...");

        try {
            const chatUrl = `${CHAT_API_URL}/webchat`;
            const response = await fetch(chatUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sessionId: sessionId, message: text, dentistryCd: dentistryCd })
            });
            if (!response.ok) throw Error("Network response was not ok");
            const data = await response.json();
            chatMessages.removeChild(chatMessages.lastChild);

            const handledAsCommand = await handleBotReply(data.reply, false);
            if (!handledAsCommand) {
                addMessage('bot', data.reply);
            }

        } catch (error) {
            console.error("Error:", error);
            chatMessages.removeChild(chatMessages.lastChild);
            addMessage("bot", "Xin lá»—i, Ä‘Ã£ cÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i.");
        } finally {
            sendButton.disabled = messageInput.value.trim() === "";
        }
    }

    async function handleBotReply(replyText, isFromHistory = false, timestamp = null) {
        try {
            const command = JSON.parse(replyText);
            if (command && command.intent) {
                switch (command.intent) {
                    case 'list_dentistries':
                        await fetchAndDisplayDentistries(command.data?.dentistryCd, isFromHistory, timestamp);
                        break;
                    default:
                        addMessage("bot", "Lá»‡nh khÃ´ng xÃ¡c Ä‘á»‹nh.", isFromHistory, timestamp);
                }
                return true; // ÄÃ£ xá»­ lÃ½ thÃ nh cÃ´ng nhÆ° má»™t cÃ¢u lá»‡nh
            }
        } catch (error) {
            // KhÃ´ng pháº£i JSON, khÃ´ng lÃ m gÃ¬ cáº£ vÃ  tráº£ vá» false
        }
        return false; // KhÃ´ng pháº£i lÃ  má»™t cÃ¢u lá»‡nh
    }

    async function fetchAndDisplayDentistries(dentistryCdParam = null, isFromHistory = false, timestamp = null) {
        if (!isFromHistory) {
            addMessage("bot", "Äang tÃ¬m danh sÃ¡ch nha khoa...");
        }

        let url = DENTISTRY_API_URL;
        if (dentistryCdParam) url += `?dentistryCd=${dentistryCdParam}`;

        try {
            const response = await fetch(url);
            if (!isFromHistory) chatMessages.removeChild(chatMessages.lastChild);

            if (!response.ok) {
                const errorMsg = response.status === 404 ? "KhÃ´ng tÃ¬m tháº¥y nha khoa báº¡n yÃªu cáº§u." : "Lá»—i khi táº£i dá»¯ liá»‡u nha khoa.";
                addMessage("bot", errorMsg, isFromHistory, timestamp);
                return;
            }

            const data = await response.json();
            let dentistries = Array.isArray(data) ? data : [data];
            let formattedMessage;

            if (dentistries.length === 0) {
                formattedMessage = "KhÃ´ng cÃ³ nha khoa nÃ o trong há»‡ thá»‘ng.";
            } else {
                formattedMessage = "DÆ°á»›i Ä‘Ã¢y lÃ  danh sÃ¡ch cÃ¡c nha khoa:\n";
                console.log(dentistries);
                dentistries.forEach(d => {
                    formattedMessage += `\n- TÃªn: ${d.name}\n  Äá»‹a chá»‰: ${d.address}`;
                });
            }
            addMessage("bot", formattedMessage, isFromHistory, timestamp);
        } catch (error) {
            console.error("Error fetching dentistries:", error);
            if (!isFromHistory) chatMessages.removeChild(chatMessages.lastChild);
            addMessage("bot", "Xin lá»—i, khÃ´ng thá»ƒ táº£i danh sÃ¡ch nha khoa lÃºc nÃ y.", isFromHistory, timestamp);
        }
    }

    function addWelcomeMessage() {
        if (chatMessages.querySelectorAll(".message-wrapper").length === 0) {
            addMessage("bot", messageHello);
            updateAllDateSeparators();
        }
    }

    chatToggle.addEventListener("click", () => {
        chatWidget.classList.toggle("open");
        if (chatWidget.classList.contains("open") && !hasInitiallyLoaded) {
            loadChatHistory(true);
        }
    });
    chatCloseBtn.addEventListener("click", () => chatWidget.classList.remove("open"));
    chatMessages.addEventListener("scroll", () => {
        if (chatMessages.scrollTop === 0 && !isLoadingMore && hasMoreMessages) {
            loadChatHistory(false);
        }
    });
    chatMessages.addEventListener("click", e => {
        const messageWrapper = e.target.closest(".message-wrapper");
        if (!messageWrapper) return;
        const timestampEl = messageWrapper.querySelector(".message-timestamp");
        if (timestampEl) {
            document.querySelectorAll(".message-timestamp.show").forEach(el => {
                if (el !== timestampEl) el.classList.remove("show");
            });
            timestampEl.classList.toggle("show");
        }
    });
    chatForm.addEventListener("submit", e => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (text) sendMessage(text);
    });
    messageInput.addEventListener("input", () => {
        sendButton.disabled = messageInput.value.trim() === "";
    });

    initializeWidget();
});